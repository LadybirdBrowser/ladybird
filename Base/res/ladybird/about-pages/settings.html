<!doctype html>
<html>
    <head>
        <title>Settings</title>
        <link rel="stylesheet" type="text/css" href="resource://ladybird/ladybird.css" />
        <style>
            @media (prefers-color-scheme: light) {
                :root {
                    --card-background-color: #f9f9f9;
                    --card-header-background-color: #f0f2f5;

                    --input-background-color: white;

                    --border-color: #dcdde1;
                }
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --card-background-color: #2c2c2c;
                    --card-header-background-color: #252525;

                    --border-color: #3d3d3d;
                }
            }

            * {
                box-sizing: border-box;
            }

            body {
                max-width: 800px;

                margin: 0 auto;
                padding: 20px;
            }

            header {
                display: flex;
                align-items: center;

                margin-bottom: 30px;
            }

            header h1 {
                font-size: 20px;
            }

            header img {
                height: 48px;
                margin-right: 10px;
                float: left;
            }

            hr {
                height: 1px;
                background-color: var(--border-color);
                border: none;
            }

            .card {
                background-color: var(--card-background-color);

                border-radius: 8px;
                margin-bottom: 20px;

                overflow: hidden;
            }

            .card-header {
                background-color: var(--card-header-background-color);

                border-bottom: 1px solid var(--border-color);
                padding: 15px 20px;
            }

            .card-body {
                padding: 20px;
            }

            .card-body > hr {
                margin: 0 8px 16px 8px;
            }

            .card-group {
                margin-bottom: 20px;
            }

            .card-group:last-child {
                margin-bottom: 0;
            }

            .inline-container {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }

            .button-container {
                display: flex;
                justify-content: flex-end;
                gap: 10px;

                margin-top: 20px;
            }

            .forcibly-enabled {
                font-size: 14px;
                opacity: 0.6;
            }

            label {
                display: block;
                margin-bottom: 8px;

                font-size: 14px;
            }

            input[type="text"],
            input[type="url"],
            select {
                background-color: var(--input-background-color);

                width: 100%;
                border: 1px solid var(--border-color);
            }

            input[type="text"].success,
            input[type="url"].success {
                border: 1px solid green;
            }

            input[type="text"].error,
            input[type="url"].error {
                border: 1px solid red;
            }

            dialog {
                background-color: var(--card-background-color);
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);

                width: 90%;
                max-width: 500px;

                margin: auto;
                padding: 0;

                border: none;
                border-radius: 8px;
                outline: none;
            }

            dialog::backdrop {
                background-color: rgba(0, 0, 0, 0.5);
            }

            dialog .dialog-header {
                background-color: var(--card-header-background-color);

                display: flex;
                justify-content: space-between;
                align-items: center;

                padding: 15px 20px;
            }

            dialog .dialog-body {
                height: 450px;

                border-top: 1px solid var(--border-color);

                display: flex;
                flex-direction: column;

                padding: 15px 20px;
            }

            dialog .dialog-body label {
                font-size: 16px;
            }

            dialog .dialog-body hr {
                margin: 8px 4px 10px 4px;
            }

            dialog .dialog-form {
                border-top: 1px solid var(--border-color);

                display: flex;
                flex-direction: column;

                padding: 15px 20px;
            }

            dialog .form-group {
                margin-bottom: 20px;
            }

            dialog .dialog-footer {
                display: flex;
                justify-content: flex-end;

                border-top: 1px solid var(--border-color);

                padding: 15px 20px;
                gap: 10px;
            }

            dialog .dialog-title {
                font-size: 18px;
                font-weight: 500;
            }

            dialog .dialog-button {
                background: none;
                border: none;
                outline: none;

                padding: 0;

                font-size: 22px;
                opacity: 0.8;

                cursor: pointer;
            }

            dialog .dialog-button:hover {
                opacity: 1;
            }

            dialog .dialog-button:disabled {
                opacity: 0.3;
            }

            dialog .dialog-description {
                margin-bottom: 10px;

                font-size: 14px;
                opacity: 0.7;
            }

            dialog .dialog-list {
                outline: 1px solid var(--border-color);
                border-radius: 4px;

                margin: 10px 0;

                font-size: 14px;

                overflow-y: auto;
                flex-grow: 1;
            }

            dialog .dialog-list-item {
                padding: 10px;

                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            dialog .dialog-list-item:hover {
                background-color: var(--card-header-background-color);
            }

            dialog .dialog-list-item-placeholder {
                padding: 10px;
                opacity: 0.6;
            }

            dialog .dialog-list-item-label {
                flex-grow: 1;
            }

            dialog .dialog-controls {
                display: flex;
                justify-content: flex-end;

                margin-top: auto;
                gap: 10px;
            }

            dialog .dialog-controls button svg {
                width: 16px;
                height: 16px;
            }

            dialog .dialog-controls input,
            dialog .dialog-controls select {
                flex-grow: 1;
            }
        </style>
    </head>
    <body>
        <header>
            <picture>
                <source
                    srcset="resource://icons/128x128/app-browser.png"
                    media="(prefers-color-scheme: dark)"
                />
                <img src="resource://icons/128x128/app-browser-dark.png" />
            </picture>
            <h1>Ladybird Settings</h1>
        </header>

        <div class="card">
            <div class="card-header">General</div>
            <div class="card-body">
                <div class="card-group">
                    <label for="new-tab-page-url">New Tab Page URL</label>
                    <input id="new-tab-page-url" type="url" placeholder="about:newtab" />
                </div>

                <hr />

                <div class="card-group inline-container">
                    <span>Languages</span>
                    <button id="languages-settings" class="secondary-button">Settings...</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Search</div>
            <div class="card-body">
                <div class="card-group inline-container">
                    <label for="search-toggle">Enable Search</label>
                    <input id="search-toggle" type="checkbox" switch />
                </div>
                <div class="card-group hidden">
                    <label for="search-engine">Default Search Engine</label>
                    <div class="inline-container">
                        <select id="search-engine">
                            <option value="">Please select a search engine</option>
                            <hr />
                        </select>
                        <button id="search-settings" class="secondary-button">Settings...</button>
                    </div>
                </div>

                <hr />

                <div class="card-group inline-container">
                    <label for="autocomplete-toggle">Enable Autocomplete</label>
                    <input id="autocomplete-toggle" type="checkbox" switch />
                </div>
                <div class="card-group hidden">
                    <label for="autocomplete-engine">Default Autocomplete Engine</label>
                    <select id="autocomplete-engine">
                        <option value="">Please select an autocomplete engine</option>
                        <hr />
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Permissions</div>
            <div class="card-body">
                <div class="card-group inline-container">
                    <span>Autoplay</span>
                    <span id="autoplay-forcibly-enabled" class="forcibly-enabled hidden">
                        This setting is controlled via the command line
                    </span>
                    <button id="autoplay-settings" class="secondary-button">Settings...</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Privacy</div>
            <div class="card-body">
                <div class="card-group inline-container">
                    <label for="do-not-track-toggle">Send websites a "Do Not Track" request</label>
                    <input id="do-not-track-toggle" type="checkbox" switch />
                </div>
            </div>
        </div>

        <div class="button-container">
            <button id="restore-defaults" class="primary-button">Restore&nbsp;Defaults</button>
        </div>

        <dialog id="languages-dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Languages</h3>
                <button id="languages-close" class="close-button dialog-button">&times;</button>
            </div>
            <div class="dialog-body">
                <p class="dialog-description">
                    Choose languages for websites in order of preference
                </p>
                <div id="languages-list" class="dialog-list"></div>
                <div class="dialog-controls">
                    <select id="languages-select">
                        <option value="">Select a language to add...</option>
                    </select>
                    <button id="languages-add" class="primary-button" disabled>Add</button>
                </div>
            </div>
        </dialog>

        <dialog id="search-dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Search Settings</h3>
                <button id="search-close" class="close-button dialog-button">&times;</button>
            </div>
            <div class="dialog-body" style="height: 300px">
                <p class="dialog-description">Manage custom search engines</p>
                <div id="search-list" class="dialog-list"></div>
            </div>
            <div class="dialog-form">
                <div class="form-group">
                    <label for="search-custom-name">Search Engine Name</label>
                    <input id="search-custom-name" type="text" placeholder="Example" />
                </div>
                <div class="form-group">
                    <label for="search-custom-url">Search URL</label>
                    <p class="dialog-description">Use %s as a placeholder for the search query</p>
                    <input
                        id="search-custom-url"
                        type="url"
                        placeholder="https://example.com/search?q=%s"
                    />
                </div>
                <div class="dialog-controls">
                    <button id="search-custom-add" class="primary-button">Add&nbsp;Engine</button>
                </div>
            </div>
        </dialog>

        <dialog id="site-settings">
            <div class="dialog-header">
                <h3 id="site-settings-title" class="dialog-title"></h3>
                <button id="site-settings-close" class="close-button dialog-button">&times;</button>
            </div>
            <div class="dialog-body">
                <div class="inline-container">
                    <label for="site-settings-global">Enable on all sites</label>
                    <input id="site-settings-global" type="checkbox" switch />
                </div>
                <hr />
                <label>Allowlist</label>
                <div id="site-settings-list" class="dialog-list"></div>
                <div class="dialog-controls">
                    <input id="site-settings-input" type="text" placeholder="example.com" />
                    <button id="site-settings-add" class="primary-button">Add&nbsp;Site</button>
                </div>
            </div>
            <div class="dialog-footer">
                <button id="site-settings-remove-all" class="secondary-button">
                    Remove All Sites
                </button>
            </div>
        </dialog>

        <script src="resource://ladybird/about-pages/settings/languages.js"></script>

        <script>
            const newTabPageURL = document.querySelector("#new-tab-page-url");
            const languagesAdd = document.querySelector("#languages-add");
            const languagesClose = document.querySelector("#languages-close");
            const languagesDialog = document.querySelector("#languages-dialog");
            const languagesList = document.querySelector("#languages-list");
            const languagesSelect = document.querySelector("#languages-select");
            const languagesSettings = document.querySelector("#languages-settings");
            const searchClose = document.querySelector("#search-close");
            const searchCustomAdd = document.querySelector("#search-custom-add");
            const searchCustomName = document.querySelector("#search-custom-name");
            const searchCustomURL = document.querySelector("#search-custom-url");
            const searchDialog = document.querySelector("#search-dialog");
            const searchEngine = document.querySelector("#search-engine");
            const searchList = document.querySelector("#search-list");
            const searchSettings = document.querySelector("#search-settings");
            const searchToggle = document.querySelector("#search-toggle");
            const autocompleteEngine = document.querySelector("#autocomplete-engine");
            const autocompleteToggle = document.querySelector("#autocomplete-toggle");
            const autoplaySettings = document.querySelector("#autoplay-settings");
            const siteSettings = document.querySelector("#site-settings");
            const siteSettingsAdd = document.querySelector("#site-settings-add");
            const siteSettingsClose = document.querySelector("#site-settings-close");
            const siteSettingsGlobal = document.querySelector("#site-settings-global");
            const siteSettingsList = document.querySelector("#site-settings-list");
            const siteSettingsInput = document.querySelector("#site-settings-input");
            const siteSettingsRemoveAll = document.querySelector("#site-settings-remove-all");
            const siteSettingsTitle = document.querySelector("#site-settings-title");
            const doNotTrackToggle = document.querySelector("#do-not-track-toggle");
            const restoreDefaults = document.querySelector("#restore-defaults");

            // FIXME: When we support per-glyph font fallbacks, replace these SVGs with analogous code points.
            //        https://github.com/LadybirdBrowser/ladybird/issues/864
            const upwardArrowSVG =
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';
            const downwardArrowSVG =
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';

            window.settings = {};
            window.nativeSearchEngineCount = 0;

            const loadSettings = settings => {
                window.settings = settings;
                renderSettings();
            };

            const renderSettings = () => {
                newTabPageURL.classList.remove("error");
                newTabPageURL.value = window.settings.newTabPageURL;

                if (languagesDialog.open) {
                    showLanguages();
                }

                const renderEngineSettings = (type, setting) => {
                    const [name, toggle, engine] = engineForType(type);

                    if (setting?.name) {
                        toggle.checked = true;
                        engine.value = setting?.name;
                    } else {
                        toggle.checked = false;
                    }

                    renderEngine(type);
                };

                loadCustomSearchEngines();
                renderEngineSettings(Engine.search, window.settings.searchEngine);
                renderEngineSettings(Engine.autocomplete, window.settings.autocompleteEngine);

                if (searchDialog.open) {
                    showSearchEngineSettings();
                }

                const siteSetting = currentSiteSetting();

                if (siteSetting === "autoplay") {
                    showSiteSettings("Autoplay", window.settings.autoplay);
                }

                doNotTrackToggle.checked = window.settings.doNotTrack;
            };

            const containsValidURL = input => {
                return input.value.length !== 0 && input.checkValidity();
            };

            newTabPageURL.addEventListener("change", () => {
                newTabPageURL.classList.remove("success");
                newTabPageURL.classList.remove("error");

                if (!containsValidURL(newTabPageURL)) {
                    newTabPageURL.classList.add("error");
                    return;
                }

                ladybird.sendMessage("setNewTabPageURL", newTabPageURL.value);
                newTabPageURL.classList.add("success");

                setTimeout(() => {
                    newTabPageURL.classList.remove("success");
                }, 1000);
            });

            const languageDisplayName = language => {
                const item = window.languages.find(item => item.language === language);
                return item.displayName;
            };

            const saveLanguages = () => {
                ladybird.sendMessage("setLanguages", window.settings.languages);
            };

            const moveLanguage = (from, to) => {
                [window.settings.languages[from], window.settings.languages[to]] = [
                    window.settings.languages[to],
                    window.settings.languages[from],
                ];

                saveLanguages();
            };

            const removeLanguage = index => {
                window.settings.languages.splice(index, 1);
                saveLanguages();
            };

            const loadLanguages = () => {
                for (const language of window.languages) {
                    const option = document.createElement("option");
                    option.text = language.displayName;
                    option.value = language.language;

                    languagesSelect.add(option);
                }
            };

            const showLanguages = () => {
                languagesList.innerHTML = "";

                window.settings.languages.forEach((language, index) => {
                    const name = document.createElement("span");
                    name.className = "dialog-list-item-label";
                    name.textContent = languageDisplayName(language);

                    const moveUp = document.createElement("button");
                    moveUp.className = "dialog-button";
                    moveUp.innerHTML = upwardArrowSVG;
                    moveUp.title = "Move up";

                    if (index === 0) {
                        moveUp.disabled = true;
                    } else {
                        moveUp.addEventListener("click", () => {
                            moveLanguage(index, index - 1);
                        });
                    }

                    const moveDown = document.createElement("button");
                    moveDown.className = "dialog-button";
                    moveDown.innerHTML = downwardArrowSVG;
                    moveDown.title = "Move down";

                    if (index === window.settings.languages.length - 1) {
                        moveDown.disabled = true;
                    } else {
                        moveDown.addEventListener("click", () => {
                            moveLanguage(index, index + 1);
                        });
                    }

                    const remove = document.createElement("button");
                    remove.className = "dialog-button";
                    remove.innerHTML = "&times;";
                    remove.title = "Remove";

                    if (window.settings.languages.length <= 1) {
                        remove.disabled = true;
                    } else {
                        remove.addEventListener("click", () => {
                            removeLanguage(index);
                        });
                    }

                    const controls = document.createElement("div");
                    controls.className = "dialog-controls";
                    controls.appendChild(moveUp);
                    controls.appendChild(moveDown);
                    controls.appendChild(remove);

                    const item = document.createElement("div");
                    item.className = "dialog-list-item";
                    item.appendChild(name);
                    item.appendChild(controls);

                    languagesList.appendChild(item);
                });

                for (const language of languagesSelect.options) {
                    language.disabled = window.settings.languages.includes(language.value);
                }

                if (!languagesDialog.open) {
                    setTimeout(() => languagesSelect.focus());
                    languagesDialog.showModal();
                }
            };

            languagesAdd.addEventListener("click", () => {
                const language = languagesSelect.value;

                languagesAdd.disabled = true;
                languagesSelect.selectedIndex = 0;

                if (!language || window.settings.languages.includes(language)) {
                    return;
                }

                window.settings.languages.push(language);
                saveLanguages();
            });

            languagesClose.addEventListener("click", () => {
                languagesDialog.close();
            });

            languagesSelect.addEventListener("change", () => {
                languagesAdd.disabled = !languagesSelect.value;
            });

            languagesSettings.addEventListener("click", event => {
                showLanguages();
                event.stopPropagation();
            });

            const Engine = Object.freeze({
                search: 1,
                autocomplete: 2,
            });

            const engineForType = engine => {
                if (engine === Engine.search) {
                    return ["Search", searchToggle, searchEngine];
                }
                if (engine === Engine.autocomplete) {
                    return ["Autocomplete", autocompleteToggle, autocompleteEngine];
                }
                throw Error(`Unrecognized engine type ${engine}`);
            };

            const loadEngines = (type, engines) => {
                const [name, toggle, engine] = engineForType(type);

                for (const engineName of engines) {
                    const option = document.createElement("option");
                    option.text = engineName;
                    option.value = engineName;

                    engine.add(option);
                }

                if (type === Engine.search) {
                    window.nativeSearchEngineCount = engine.length;
                    engine.appendChild(document.createElement("hr"));
                }
            };

            const renderEngine = type => {
                const [name, toggle, engine] = engineForType(type);

                if (toggle.checked) {
                    engine.closest(".card-group").classList.remove("hidden");
                } else {
                    engine.closest(".card-group").classList.add("hidden");
                }

                if (toggle.checked && engine.selectedIndex !== 0) {
                    engine.item(0).disabled = true;
                } else if (!toggle.checked) {
                    engine.item(0).disabled = false;
                    engine.selectedIndex = 0;
                }
            };

            const saveEngine = type => {
                const [name, toggle, engine] = engineForType(type);

                if (toggle.checked && engine.selectedIndex !== 0) {
                    ladybird.sendMessage(`set${name}Engine`, engine.value);
                } else if (!toggle.checked) {
                    ladybird.sendMessage(`set${name}Engine`, null);
                }

                renderEngine(type);
            };

            const setSaveEngineListeners = type => {
                const [name, toggle, engine] = engineForType(type);

                toggle.addEventListener("change", () => {
                    saveEngine(type);
                });
                engine.addEventListener("change", () => {
                    saveEngine(type);
                });
            };

            setSaveEngineListeners(Engine.search);
            setSaveEngineListeners(Engine.autocomplete);

            const loadCustomSearchEngines = () => {
                while (searchEngine.length > window.nativeSearchEngineCount) {
                    searchEngine.remove(window.nativeSearchEngineCount);
                }

                const custom = window.settings.searchEngine?.custom || [];

                custom.forEach(custom => {
                    const option = document.createElement("option");
                    option.text = custom.name;
                    option.value = custom.name;

                    searchEngine.add(option);
                });
            };

            const showSearchEngineSettings = () => {
                searchCustomName.classList.remove("error");
                searchCustomURL.classList.remove("error");
                searchList.innerHTML = "";

                const custom = window.settings.searchEngine?.custom || [];

                if (custom.length === 0) {
                    const placeholder = document.createElement("div");
                    placeholder.className = "dialog-list-item-placeholder";
                    placeholder.textContent = "No custom search engines added";

                    searchList.appendChild(placeholder);
                }

                custom.forEach(custom => {
                    const name = document.createElement("span");
                    name.textContent = custom.name;

                    const url = document.createElement("span");
                    url.className = "dialog-list-item-placeholder";
                    url.style = "padding-left: 0";
                    url.textContent = ` â€” ${custom.url}`;

                    const engine = document.createElement("span");
                    engine.className = "dialog-list-item-label";
                    engine.appendChild(name);
                    engine.appendChild(url);

                    const remove = document.createElement("button");
                    remove.className = "dialog-button";
                    remove.innerHTML = "&times;";
                    remove.title = `Remove ${custom.name}`;

                    remove.addEventListener("click", () => {
                        ladybird.sendMessage("removeCustomSearchEngine", custom);
                    });

                    const item = document.createElement("div");
                    item.className = "dialog-list-item";
                    item.appendChild(engine);
                    item.appendChild(remove);

                    searchList.appendChild(item);
                });

                if (!searchDialog.open) {
                    setTimeout(() => searchCustomName.focus());
                    searchDialog.showModal();
                }
            };

            const addCustomSearchEngine = () => {
                searchCustomName.classList.remove("error");
                searchCustomURL.classList.remove("error");

                for (const i = 0; i < searchEngine.length; ++i) {
                    if (searchCustomName.value === searchEngine.item(i).value) {
                        searchCustomName.classList.add("error");
                        return;
                    }
                }

                if (!containsValidURL(searchCustomURL)) {
                    searchCustomURL.classList.add("error");
                    return;
                }

                ladybird.sendMessage("addCustomSearchEngine", {
                    name: searchCustomName.value,
                    url: searchCustomURL.value,
                });

                searchCustomName.value = "";
                searchCustomURL.value = "";

                setTimeout(() => searchCustomName.focus());
            };

            searchCustomAdd.addEventListener("click", addCustomSearchEngine);

            searchCustomName.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    addCustomSearchEngine();
                }
            });

            searchCustomURL.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    addCustomSearchEngine();
                }
            });

            searchClose.addEventListener("click", () => {
                searchDialog.close();
            });

            searchSettings.addEventListener("click", event => {
                showSearchEngineSettings();
                event.stopPropagation();
            });

            const forciblyEnableSiteSettings = settings => {
                settings.forEach(setting => {
                    const label = document.querySelector(`#${setting}-forcibly-enabled`);
                    label.classList.remove("hidden");

                    const button = document.querySelector(`#${setting}-settings`);
                    button.classList.add("hidden");
                });
            };

            const currentSiteSetting = () => {
                if (!siteSettings.open) {
                    return null;
                }

                return siteSettingsTitle.innerText.toLowerCase();
            };

            const showSiteSettings = (title, settings) => {
                siteSettingsTitle.innerText = title;
                siteSettingsGlobal.checked = settings.enabledGlobally;
                siteSettingsList.innerHTML = "";

                siteSettingsGlobal.onchange = () => {
                    ladybird.sendMessage("setSiteSettingEnabledGlobally", {
                        setting: currentSiteSetting(),
                        enabled: siteSettingsGlobal.checked,
                    });
                };

                if (settings.siteFilters.length === 0) {
                    const placeholder = document.createElement("div");
                    placeholder.className = "dialog-list-item-placeholder";
                    placeholder.textContent = "No sites added";

                    siteSettingsList.appendChild(placeholder);
                }

                settings.siteFilters.forEach(site => {
                    const filter = document.createElement("span");
                    filter.className = "dialog-list-item-label";
                    filter.textContent = site;

                    const remove = document.createElement("button");
                    remove.className = "dialog-button";
                    remove.innerHTML = "&times;";
                    remove.title = `Remove ${site}`;

                    remove.addEventListener("click", () => {
                        ladybird.sendMessage("removeSiteSettingFilter", {
                            setting: currentSiteSetting(),
                            filter: site,
                        });
                    });

                    const item = document.createElement("div");
                    item.className = "dialog-list-item";
                    item.appendChild(filter);
                    item.appendChild(remove);

                    siteSettingsList.appendChild(item);
                });

                if (!siteSettings.open) {
                    setTimeout(() => siteSettingsInput.focus());
                    siteSettings.showModal();
                }
            };

            const addSiteSettingFilter = () => {
                ladybird.sendMessage("addSiteSettingFilter", {
                    setting: currentSiteSetting(),
                    filter: siteSettingsInput.value,
                });

                siteSettingsInput.classList.add("success");
                siteSettingsInput.value = "";

                setTimeout(() => {
                    siteSettingsInput.classList.remove("success");
                }, 1000);

                setTimeout(() => siteSettingsInput.focus());
            };

            siteSettingsAdd.addEventListener("click", addSiteSettingFilter);

            siteSettingsInput.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    addSiteSettingFilter();
                }
            });

            siteSettingsClose.addEventListener("click", () => {
                siteSettings.close();
            });

            siteSettingsRemoveAll.addEventListener("click", () => {
                ladybird.sendMessage("removeAllSiteSettingFilters", {
                    setting: currentSiteSetting(),
                });
            });

            autoplaySettings.addEventListener("click", event => {
                showSiteSettings("Autoplay", window.settings.autoplay);
                event.stopPropagation();
            });

            doNotTrackToggle.addEventListener("change", () => {
                ladybird.sendMessage("setDoNotTrack", doNotTrackToggle.checked);
            });

            restoreDefaults.addEventListener("click", () => {
                ladybird.sendMessage("restoreDefaultSettings");
            });

            // FIXME: Once we support `dialog::backdrop`, this event listener should be on `siteSettings`.
            document.addEventListener("click", event => {
                const close = dialog => {
                    if (!dialog.open) {
                        return;
                    }

                    const rect = dialog.getBoundingClientRect();

                    if (
                        event.clientX < rect.left ||
                        event.clientX > rect.right ||
                        event.clientY < rect.top ||
                        event.clientY > rect.bottom
                    ) {
                        dialog.close();
                    }
                };

                document.querySelectorAll("dialog").forEach(close);
            });

            document.addEventListener("WebUILoaded", () => {
                ladybird.sendMessage("loadAvailableEngines");
                ladybird.sendMessage("loadCurrentSettings");
                ladybird.sendMessage("loadForciblyEnabledSiteSettings");
                loadLanguages();
            });

            document.addEventListener("WebUIMessage", event => {
                if (event.detail.name === "loadSettings") {
                    loadSettings(event.detail.data);
                } else if (event.detail.name === "loadEngines") {
                    loadEngines(Engine.search, event.detail.data.search);
                    loadEngines(Engine.autocomplete, event.detail.data.autocomplete);
                } else if (event.detail.name === "forciblyEnableSiteSettings") {
                    forciblyEnableSiteSettings(event.detail.data);
                }
            });
        </script>
    </body>
</html>
